<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>R Notebook - Swayer</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "R Notebook";
        var mkdocs_page_input_path = "10 Bayesian Statistics/HW6.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Swayer
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">CPA Data Analysis</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../000%20CPA%20Data%20Analysis/likelihood/">Likelihood</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Swayer</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">R Notebook</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="bayes-statistics-hw6">Bayes Statistics HW6</h1>
<h2 id="10-4">10-4</h2>
<h3 id="10-4a">10-4a</h3>
<p>Suppose that <span class="arithmatex">\(\theta\)</span> is drawn forme the density proportional to <span class="arithmatex">\(g(\theta)\)</span>, and U is a random Uniform(0,1) draw. Then we can express the cdf of draws accepted by rejection sampling as </p>
<div class="arithmatex">\[Pr(\theta \leq \theta^*|\theta \ is\ accepted) = \frac{Pr(\theta \leq \theta^*\ and \ U \leq \frac{p(\theta|y)}{Mg(\theta)})}{Pr(U \leq \frac{p(\theta|y)}{Mg(\theta)})} \]</div>
<div class="arithmatex">\[\frac{\int_{-\infty}^{\theta^*}\int_0^{p(\theta|y)/(Mg(]\theta))}g(\theta)dud\theta}
{\int_{-\infty}^{\infty}\int_0^{p(\theta|y)/(Mg(\theta))}g(\theta)dud\theta}\]</div>
<div class="arithmatex">\[\frac{\frac{1}{M}\int_{-\infty}^{\theta^*}p(\theta
|y)d\theta }{\frac{1}{M}}\]</div>
<p>which is the cdf for <span class="arithmatex">\(p(\theta|y)\)</span>.</p>
<h3 id="10-4b">10-4b</h3>
<p>Above proof requires that  (i) <span class="arithmatex">\(g(\theta) &gt; 0\)</span> wherever <span class="arithmatex">\(p(\theta) &gt; 0\)</span> and that (ii) <span class="arithmatex">\(p(\theta)/Mg(\theta) \leq 1\)</span> always. If <span class="arithmatex">\(p/g\)</span> is unbounded, than one or both of (i) and (ii) will be violated.</p>
<h2 id="11-1">11-1</h2>
<p>As described on 279, consider any two points <span class="arithmatex">\(\theta_a\)</span> and <span class="arithmatex">\(\theta_b\)</span> at iteration t labeled so that <span class="arithmatex">\(p(\theta_b|y)J_t(\theta_a|\theta_b) \geq p(\theta_a|y)J_t(\theta_b|\theta_a)\)</span>. To show that the posterior distribution is a stationary distribution, suppose that <span class="arithmatex">\(\theta^{t-1}\)</span> is a draw from the posterior distribution. Then teh unconditional probability density of a transition from <span class="arithmatex">\(\theta_a\)</span> to <span class="arithmatex">\(\theta_b\)</span> is </p>
<p>$<span class="arithmatex">\(p(\theta^{t-1}=\theta_a,\theta^t=\theta_b) = p(\theta_a|y)J_t(\theta_b|\theta_a)\)</span>$,</p>
<p>where the acceptance probability is 1 cuz of our labeling of a and b so that the ratio of importance ratios is at least 1. The uncinditional probability density of a transition from <span class="arithmatex">\(\theta_b\)</span> to <span class="arithmatex">\(\theta_a\)</span> is </p>
<p>$<span class="arithmatex">\(p(\theta^t=\theta_a,\theta^{t-1}=\theta_b)=p(\theta_b|y)J_t(\theta_a|\theta_b)(\frac{p(\theta_a|y)/J_t(\theta_)a|\theta_b)}{p(\theta_b|y)/J_t(\theta_b|\theta_a)})\)</span>$,</p>
<p>whichi is the same as the unconditional probability in the other direction. Since their joint distribution is symmetric, <span class="arithmatex">\(\theta^t\)</span> and <span class="arithmatex">\(\theta^{t-1}\)</span> have the same marginal distributions, and so <span class="arithmatex">\(p(\theta|y)\)</span> is a stationary distribution of the Markov chain.</p>
<p>As with the Metropolis algorithm, the stationary distribution is unique if the Markov chain is irreducible, aperiodic, and not transient.</p>
<h2 id="importance-sampling-with-normal-distribution-as-a-proposal-for-bioassay-model">Importance sampling with normal distribution as a proposal for Bioassay model</h2>
<pre><code class="language-r">library(ggplot2)
theme_set(theme_minimal())
library(gridExtra)
library(grid)
library(tidyr)
library(MASS)
library(loo)
</code></pre>
<pre><code>## This is loo version 2.4.1
</code></pre>
<pre><code>## - Online documentation and vignettes at mc-stan.org/loo
</code></pre>
<pre><code>## - As of v2.0.0 loo defaults to 1 core but we recommend using as many as possible. Use the 'cores' argument or set options(mc.cores = NUM_CORES) for an entire session.
</code></pre>
<pre><code class="language-r">df1 &lt;- data.frame(x = c(-0.86, -0.30, -0.05, 0.73),n = c(5, 5, 5, 5),
y = c(0, 1, 3, 5))
A = seq(-1.5, 7, length.out = 100)
B = seq(-5, 35, length.out = 100)
# make vectors that contain all pairwise combinations of A and B
cA &lt;- rep(A, each = length(B))
cB &lt;- rep(B, length(A))
</code></pre>
<pre><code class="language-r">logl &lt;- function(df, a, b)
  df['y']*(a + b*df['x']) - df['n']*log1p(exp(a + b*df['x']))
# calculate likelihoods: apply logl function for each observation
# ie. each row of data frame of x, n and y
p &lt;- apply(df1, 1, logl, cA, cB) %&gt;%
  # sum the log likelihoods of observations
  # and exponentiate to get the joint likelihood
  rowSums() %&gt;% exp()
nsamp &lt;- 1000
samp_indices &lt;- sample(length(p), size = nsamp,
                       replace = T, prob = p/sum(p))
samp_A &lt;- cA[samp_indices[1:nsamp]]
samp_B &lt;- cB[samp_indices[1:nsamp]]
# add random jitter, see BDA3 p. 76
samp_A &lt;- samp_A + runif(nsamp, (A[1] - A[2])/2, (A[2] - A[1])/2)
samp_B &lt;- samp_B + runif(nsamp, (B[1] - B[2])/2, (B[2] - B[1])/2)
samp_ld50 &lt;- -samp_A/samp_B
</code></pre>
<pre><code class="language-r">xl &lt;- c(-2, 7)
yl &lt;- c(-2, 35)
pos &lt;- ggplot(data = data.frame(cA ,cB, p), aes(x = cA, y = cB)) +
  geom_raster(aes(fill = p, alpha = p), interpolate = T) +
  geom_contour(aes(z = p), colour = 'black', size = 0.2) +
  coord_cartesian(xlim = xl, ylim = yl) +
  labs(x = 'alpha', y = 'beta') +
  scale_fill_gradient(low = 'yellow', high = 'red', guide = F) +
  scale_alpha(range = c(0, 1), guide = F)
pos
</code></pre>
<p><img alt="" src="../HW6_files/figure-html/unnamed-chunk-3-1.png" /><!-- --></p>
<pre><code class="language-r">sam &lt;- ggplot(data = data.frame(samp_A, samp_B)) +
  geom_point(aes(samp_A, samp_B), color = 'blue', size = 0.3) +
  coord_cartesian(xlim = xl, ylim = yl) +
  labs(x = 'alpha', y = 'beta')
sam
</code></pre>
<p><img alt="" src="../HW6_files/figure-html/unnamed-chunk-4-1.png" /><!-- --></p>
<pre><code class="language-r">his &lt;- ggplot() +
  geom_histogram(aes(samp_ld50), binwidth = 0.05,
                 fill = 'steelblue', color = 'black') +
  coord_cartesian(xlim = c(-0.8, 0.8)) +
  labs(x = 'LD50 = -alpha/beta')
his
</code></pre>
<p><img alt="" src="../HW6_files/figure-html/unnamed-chunk-5-1.png" /><!-- --></p>
<p>Normal approximation for Bioassay model</p>
<pre><code class="language-r">bioassayfun &lt;- function(w, df) {
  z &lt;- w[1] + w[2]*df$x
  -sum(df$y*(z) - df$n*log1p(exp(z)))
}
w0 &lt;- c(0,0)
optim_res &lt;- optim(w0, bioassayfun, gr = NULL, df1, hessian = T)
w &lt;- optim_res$par
S &lt;- solve(optim_res$hessian)
dmvnorm &lt;- function(x, mu, sig)
  exp(-0.5*(length(x)*log(2*pi) + log(det(sig)) + (x-mu)%*%solve(sig, x-mu)))
p &lt;- apply(cbind(cA, cB), 1, dmvnorm, w, S)
samp_norm &lt;- mvrnorm(nsamp, w, S)
bpi &lt;- samp_norm[,2] &gt; 0
samp_norm_ld50 &lt;- -samp_norm[bpi,1]/samp_norm[bpi,2]
</code></pre>
<pre><code class="language-r">pos_norm &lt;- ggplot(data = data.frame(cA ,cB, p), aes(x = cA, y = cB)) +
  geom_raster(aes(fill = p, alpha = p), interpolate = T) +
  geom_contour(aes(z = p), colour = 'black', size = 0.2) +
  coord_cartesian(xlim = xl, ylim = yl) +
  labs(x = 'alpha', y = 'beta') +
  scale_fill_gradient(low = 'yellow', high = 'red', guide = F) +
  scale_alpha(range = c(0, 1), guide = F)
pos_norm
</code></pre>
<p><img alt="" src="../HW6_files/figure-html/unnamed-chunk-7-1.png" /><!-- --></p>
<pre><code class="language-r">sam_norm &lt;- ggplot(data = data.frame(samp_A=samp_norm[,1], samp_B=samp_norm[,2])) +
  geom_point(aes(samp_A, samp_B), color = 'blue', size = 0.3) +
  coord_cartesian(xlim = xl, ylim = yl) +
  labs(x = 'alpha', y = 'beta')
sam_norm
</code></pre>
<p><img alt="" src="../HW6_files/figure-html/unnamed-chunk-7-2.png" /><!-- --></p>
<pre><code class="language-r">his_norm &lt;- ggplot() +
  geom_histogram(aes(samp_norm_ld50), binwidth = 0.05,
                 fill = 'steelblue', color = 'black') +
  coord_cartesian(xlim = c(-0.8, 0.8)) +
  labs(x = 'LD50 = -alpha/beta, beta &gt; 0')
his_norm
</code></pre>
<p><img alt="" src="../HW6_files/figure-html/unnamed-chunk-8-1.png" /><!-- --></p>
<p>Importance sampling for Bioassay model</p>
<pre><code class="language-r">ldmvnorm &lt;- function(x, mu, sig)
(-0.5*(length(x)*log(2*pi) + log(det(sig)) + (x-mu)%*%solve(sig, x-mu)))
lg &lt;- apply(samp_norm, 1, ldmvnorm, w, S)
lp &lt;- apply(df1, 1, logl, samp_norm[,1], samp_norm[,2]) %&gt;% rowSums()
lw &lt;- lp-lg
psislw &lt;- psis(lw, r_eff = 1)
</code></pre>
<pre><code>## Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.
</code></pre>
<pre><code class="language-r">print(psislw$diagnostics$pareto_k, digits=2)
</code></pre>
<pre><code>## [1] 0.74
</code></pre>
<pre><code class="language-r">print(psislw$diagnostics$n_eff, digits=2)
</code></pre>
<pre><code>## [1] 385
</code></pre>
<pre><code class="language-r">psisw &lt;- exp(psislw$log_weights)
</code></pre>
<pre><code class="language-r">samp_indices &lt;- sample(length(psisw), size = nsamp,
                       replace = T, prob = psisw)
rissamp_A &lt;- samp_norm[samp_indices,1]
rissamp_B &lt;- samp_norm[samp_indices,2]
# add random jitter, see BDA3 p. 76
rissamp_A &lt;- rissamp_A + runif(nsamp, (A[1] - A[2])/2, (A[2] - A[1])/2)
rissamp_B &lt;- rissamp_B + runif(nsamp, (B[1] - B[2])/2, (B[2] - B[1])/2)
# samples of LD50 
rissamp_ld50 &lt;- -rissamp_A/rissamp_B
sam_ris &lt;- ggplot(data = data.frame(rissamp_A, rissamp_B)) +
  geom_point(aes(rissamp_A, rissamp_B), color = 'blue', size = 0.3) +
  coord_cartesian(xlim = xl, ylim = yl) +
  labs(x = 'alpha', y = 'beta')
sam_ris
</code></pre>
<p><img alt="" src="../HW6_files/figure-html/unnamed-chunk-10-1.png" /><!-- --></p>
<pre><code class="language-r">his_ris &lt;- ggplot() +
  geom_histogram(aes(rissamp_ld50), binwidth = 0.05,
                 fill = 'steelblue', color = 'black') +
  coord_cartesian(xlim = c(-0.8, 0.8)) +
  labs(x = 'LD50 = -alpha/beta')
his_ris
</code></pre>
<p><img alt="" src="../HW6_files/figure-html/unnamed-chunk-10-2.png" /><!-- --></p>
<pre><code class="language-r">blank &lt;- grid.rect(gp=gpar(col=&quot;white&quot;))
</code></pre>
<p><img alt="" src="../HW6_files/figure-html/unnamed-chunk-11-1.png" /><!-- --></p>
<pre><code class="language-r">grid.arrange(pos, sam, his, pos_norm, sam_norm, his_norm, blank, sam_ris, his_ris, ncol=3)
</code></pre>
<p><img alt="" src="../HW6_files/figure-html/unnamed-chunk-11-2.png" /><!-- --></p>
<h2 id="gibbs-sampling">Gibbs sampling</h2>
<h2 id="metropolis-sampling-convergence-illustration">Metropolis sampling + convergence illustration</h2>
<h2 id="metropolis-sampling-convergence-illustration_1">Metropolis sampling + convergence illustration</h2>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
